<!-- TOP CTA: Summarize Fantasy Impact (left-justified, light green) -->
<style>
  /* Top bar container (sticky at top, full-width) */
  .ff-topbar {
    position: sticky;
    top: 0;
    z-index: 10000;
    display: flex;
    justify-content: flex-start;           /* left-justify the button */
    padding: 12px 16px;
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(6px);
    border-bottom: 1px solid #eee;
  }
  /* Large light-green button */
  .ff-topbar .ff-cta {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    font-weight: 700;
    font-size: 2rem;                       /* ~2x bigger text */
    padding: 18px 22px;
    border-radius: 12px;
    border: 2px solid #52C552;             /* slightly darker green border */
    background: #88E788;                   /* light green */
    color: #0b3d0b;                        /* dark text for contrast */
    cursor: pointer;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    transition: transform 0.06s ease, box-shadow 0.2s ease;
  }
  .ff-topbar .ff-cta:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 22px rgba(0,0,0,0.12);
  }
  .ff-topbar .ff-cta:active { transform: translateY(0); }
  .ff-topbar .ff-cta:focus-visible {
    outline: 3px solid #2e7d32;           /* accessible focus ring */
    outline-offset: 2px;
  }
  .ff-topbar .ff-cta .ff-icon { font-size: 2.2rem; }

  /* Modal */
  .ff-modal-backdrop {
    position: fixed; inset: 0; background: rgba(0,0,0,0.4);
    display: none; align-items: center; justify-content: center; z-index: 10001;
  }
  .ff-modal {
    width: min(900px, 92vw); max-height: 80vh; overflow: auto; background: #fff;
    border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 18px 18px 10px;
  }
  .ff-modal header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
  .ff-modal h3 { margin: 0; font-size: 1.1rem; }
  .ff-modal .ff-actions { display:flex; gap:8px; }
  .ff-modal .ff-close { border: 1px solid #ddd; background:#fafafa; cursor:pointer; padding:8px 10px; border-radius:8px; }
  .ff-modal pre { white-space: pre-wrap; word-wrap: break-word; font-size: 0.95rem; line-height: 1.35; }
  .ff-muted { color: #666; font-size: 0.9rem; margin-top: 8px; }
</style>

<!-- top bar gets inserted at the very beginning of <body> -->
<div class="ff-topbar" id="ff-topbar" hidden>
  <button id="ff-summarize-btn" class="ff-cta" aria-label="Summarize Fantasy Impact">
    <span class="ff-icon" aria-hidden="true">👉</span>
    Summarize Fantasy Impact
  </button>
</div>

<!-- modal -->
<div class="ff-modal-backdrop" id="ff-modal-wrap" role="dialog" aria-modal="true" aria-labelledby="ff-modal-title">
  <div class="ff-modal">
    <header>
      <h3 id="ff-modal-title">Top 10 — Fantasy Impact Summary</h3>
      <div class="ff-actions">
        <button class="ff-close" id="ff-copy">Copy</button>
        <button class="ff-close" id="ff-close">Close</button>
      </div>
    </header>
    <pre id="ff-output">Loading…</pre>
    <div class="ff-muted">Tip: If you later wire a serverless endpoint, set <code>window.SUMMARIZE_API</code>. Otherwise this will use a precomputed summary (if present) or a local heuristic.</div>
  </div>
</div>

<script>
(function () {
  // Ensure the topbar appears at the very top of <body>
  const topbar = document.getElementById('ff-topbar');
  try { document.body.insertBefore(topbar, document.body.firstChild); } catch (e) {}
  topbar.hidden = false;

  const btn = document.getElementById('ff-summarize-btn');
  const wrap = document.getElementById('ff-modal-wrap');
  const out  = document.getElementById('ff-output');
  const closeBtn = document.getElementById('ff-close');
  const copyBtn  = document.getElementById('ff-copy');

  function show() { wrap.style.display = 'flex'; }
  function hide() { wrap.style.display = 'none'; }
  closeBtn.addEventListener('click', hide);
  wrap.addEventListener('click', (e)=>{ if (e.target === wrap) hide(); });

  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(out.textContent);
      copyBtn.textContent = 'Copied!';
      setTimeout(()=>copyBtn.textContent='Copy',1200);
    } catch(e){}
  });

  // ---------- Helpers ----------
  function baseUrl() {
    return window.location.href.replace(/index\.html?$/,'');
  }
  // Prefer precomputed summary written by your GitHub Action (top10.txt)
  async function maybePrecomputedSummary() {
    try {
      const res = await fetch(new URL('top10.txt', baseUrl()), { cache: 'no-store' });
      if (res.ok) return await res.text();
    } catch {}
    return null;
  }
  // Resolve cache.json that osmosfeed publishes alongside index.html
  function cacheUrlFromLocation() {
    return new URL('cache.json', baseUrl()).toString();
  }
  // Heuristic: pick the most relevant date field available
  function parseItemDate(it) {
    const d = it.published || it.publishedAt || it.date || it.isoDate || it.createdAt || it.updated || null;
    return d ? new Date(d) : new Date(0);
  }
  // Simple keyword tagging for “impact”
  const impactMatchers = [
    { tag: 'Injury', rx: /\b(IR|ACL|MCL|ankle|hamstring|concussion|injury|questionable|doubtful|out)\b/i },
    { tag: 'Depth Chart', rx: /\b(start|starter|bench|backup|snap|target share|workload|role|promoted|demoted)\b/i },
    { tag: 'Transaction', rx: /\b(signs|waived|traded|acquired|activated|designated to return)\b/i },
    { tag: 'Waiver', rx: /\b(waiver|pickup|stream|add\/drop)\b/i },
    { tag: 'Start/Sit', rx: /\b(start|sit|rankings|flex)\b/i },
  ];
  function tagsFor(item) {
    const text = (item.title || '') + ' ' + (item.summary || item.content || '');
    return impactMatchers.filter(m => m.rx.test(text)).map(m => m.tag);
  }
  // Optional serverless summary (leave window.SUMMARIZE_API unset to skip)
  async function maybeServerlessSummarize(items) {
    const endpoint = window.SUMMARIZE_API;
    if (!endpoint) return null;
    try {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ items })
      });
      if (res.ok) return await res.text();
    } catch (e) {}
    return null;
  }

  // ---------- Main action ----------
  async function summarize() {
    out.textContent = 'Loading summary…';
    show();

    // 0) Try precomputed AI summary from GitHub Actions
    const pre = await maybePrecomputedSummary();
const isPlaceholder = pre && /No recent items found in cache\.json/i.test(pre);
if (pre && !isPlaceholder) {
  out.textContent = pre; 
  return;        // use AI precompute
}
// else: keep going to serverless or heuristic fallback

    // 1) Load cache.json (osmosfeed output)
    const cacheUrl = cacheUrlFromLocation();
    let data;
    try {
      const res = await fetch(cacheUrl, { cache: 'no-store' });
      data = await res.json();
    } catch (e) {
      out.textContent = `Could not load cache.json at ${cacheUrl}\n\n${e}`;
      return;
    }

    const items = (data.items || data.entries || data || []).slice()
      .sort((a,b) => parseItemDate(b) - parseItemDate(a))
      .slice(0, 10);

    // 2) Use serverless summary if available (optional)
    const serverless = await maybeServerlessSummarize(items);
    if (serverless) { out.textContent = serverless; return; }

    // 3) Client-side heuristic fallback (no API keys)
    const lines = [];
    lines.push('**Summary of Fantasy Impact (Top 10)**');
    const seenTitles = new Set();
    items.forEach((it, idx) => {
      const title = (it.title || 'Untitled').trim();
      if (seenTitles.has(title)) return;
      seenTitles.add(title);
      const url = it.link || it.url || '';
      const date = parseItemDate(it);
      const when = isNaN(date) ? '' : ` — ${date.toLocaleString()}`;
      const t = tagsFor(it);
      const tagStr = t.length ? ` [${t.join(', ')}]` : '';
      lines.push(`${idx+1}. ${title}${tagStr}${when}${url ? `\n   ${url}` : ''}`);
    });
    lines.push('\nNote: Auto-tagging is keyword-based; open sources for details.');
    out.textContent = lines.join('\n');
  }

  btn.addEventListener('click', summarize);
})();
</script>
